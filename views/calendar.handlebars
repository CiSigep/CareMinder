{{#section 'head'}}
<meta charset='utf-8' />

<link href='https://unpkg.com/@fullcalendar/core/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/daygrid/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/list/main.min.css' rel="stylesheet" />
<link href='https://unpkg.com/@fullcalendar/timeline/main.min.css' rel='stylesheet' />
<link href='https://use.fontawesome.com/releases/v5.0.6/css/all.css' rel='stylesheet'>
<link href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css' rel='stylesheet' />
{{!-- <link href='fullcalendar/bootstrap/main.css' rel='stylesheet' /> --}}
<link href='https://unpkg.com/@fullcalendar/timegrid/main.min.css' rel="stylesheet" />
<link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
<link href="/styles/styles.css" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<!-- <link href='node_modules/@fullcalendar/resource-timeline/main.css' rel='stylesheet' /> requires premium -->

<script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src='https://unpkg.com/@fullcalendar/core/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/daygrid/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/timegrid/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/list/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/interaction/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/bootstrap/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/resource-common/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/resource-daygrid/main.min.js'></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"
    integrity="sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=" crossorigin="anonymous"></script>

<!-- <script src='fullcalendar/resource-timeline/main.js'></script> requires premium -->

<script>

    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        //console.log($("#startingPatient").val());
        var selectedPatient = $("#startingPatient").val() !== -1 ? $("#startingPatient").val() : $("#patientDropdown a:first-child").attr("data-patientid");
        //console.log(selectedPatient);
        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['dayGrid', 'interaction', 'timeGrid', 'list', 'bootstrap'],
            timeZone: 'local',
            themeSystem: 'bootstrap',
            header: {
                left: 'prev,next, today, custom1, custom2',
                center: 'title',
                right: ', dayGridMonth,timeGridWeek,timeGridDay,listMonth'
            },
            editable: false, // We want to update the events programmatically
            eventLimit: true, //too many events in a day, show popover
            customButtons: {
                custom1: {
                    text: 'add task',
                    click: function () {
                        $("#taskModal").modal();
                    }
                },
                custom2: {
                    text: 'add bill',
                    click: function () {
                        $("#billModal").modal();
                    }

                }
            },
            eventClick: function (info) { // https://fullcalendar.io/docs/eventClick
                $("#eventIdSpan").text(info.event.title);

                $("#eventClickModal").modal();
            }
        });


        calendar.render();

        $("#repeatsCheck").on("click", function (e) { // only allow editing of the interval if this is checked
            // They may need to be cleared too.
            var check = $(this).prop("checked");
            $("#repeatNumber").attr("disabled", !check);
            $("#intervalSelect").attr("disabled", !check);
        });

        $("#saveTaskBtn").on("click", function (e) {
            var newTask = { // https://fullcalendar.io/docs/event-parsing
                title: $("#taskTitle").val(),
                start: moment($("#taskStart").val() + " " + $("taskTimeStart").val(), "MM-DD-YYYY HH:mm a").format(),
                end: moment($("#taskEnd").val() + " " + $("taskTimeEnd").val(), "MM-DD-YYYY HH:mm a").format(),
                extendedProps: { // Where non-FullCalendar properties go
                    priority: $("#prioritySelect").val(),
                    repeats: $("#repeatsCheckTask").prop("checked"),
                    intervalNum: $("#repeatNumberTask").val(),
                    time: $("#intervalSelectTask").val(),
                },
            };
            var taskObject = {
                title: newTask.title,
                priority: newTask.extendedProps.priority,
                repeats: newTask.extendedProps.repeats,
                interval: newTask.extendedProps.repeats ? newTask.extendedProps.intervalNum + newTask.extendedProps.time : null,
                start: newTask.start,
                end: newTask.end,
                PatientId: selectedPatient
            }
            $.ajax({
                url: "/api/task",
                method: "POST",
                data: taskObject
            }).done(function(data){
                // Clear out modal
                $("#taskModal input:text").val("");
                // add to calendar
                calendar.addEvent(data);
                $("#saveTaskModal").modal("hide");
            }).fail(function(err) {
            });
        });
        $("#saveBillBtn").on("click", function (e) {
            var newBill = { // https://fullcalendar.io/docs/event-parsing
                title: $("#billPayTo").val(),
                start: moment($("#billDue").val(), "MM-DD-YYYY").format(), allDay: true,
                // end: new Date($("#billEnd").val()),
                extendedProps: { // Where non-FullCalendar properties go
                    amount: $("#billAmount").val(),
                    time: $("#intervalSelectBill").val(),
                    reason: $("#billReason").val(),
                    repeats: $("#repeatCheckBill").prop("checked"),
                    intervalNum: $("#repeatNumberBill").val(),
                },
            };
            var billObject = {
                payTo: newBill.title,
                due: newBill.start,
                amount: newBill.extendedProps.amount,
                interval: newBill.extendedProps.repeats ? newBill.extendedProps.intervalNum + newBill.extendedProps.time : null,
                reason: newBill.extendedProps.reason,
                repeats: newBill.extendedProps.repeats,
                PatientId: selectedPatient
            };
            $.ajax({
                url: "/api/bill",
                method: "POST",
                data: billObject
            }).done(function(data){
                newBill.id = data.id;
                // Clear out modal
                $("#billModal input:text").val("");
                // add to calendar
                calendar.addEvent(newBill);
                $("#billModal").modal("hide");
            }).fail(function(err) {
            });

        });
        // Before you do this, send it to the database.
        //var ev = calendar.addEvent(newTask);
        //var ev = calendar.addEvent(newBill);
        // You need to clear out the modal input values.

        //console.log(ev.extendedProps);
        $('#saveTaskModal').modal('hide');
        $('#billModal').modal('hide');
    });

</script>
{{/section}}

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a href="/public/html/main.html"><i class="fas fa-home fa-2x"></i></a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    Patients
                </a>
                <div id="patientDropdown" class="dropdown-menu" aria-labelledby="navbarDropdown">
                    {{#each Patients}}
                    <a class="dropdown-item patient-select" data-patientId="{{id}}" href="#">{{firstName}}
                        {{lastName}}</a>
                    {{/each}}
                </div>
            </li>
        </ul>
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <span class="navbar-brand" id="logo">CareMinder</span>
            </li>
        </ul>
    </div>
</nav>

<br>
<div class="container">
    <div id='calendar'></div>
    <div class="modal fade" id="taskModal" abindex="-1" role="dialog" aria-labelledby="taskLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskLabel">Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="taskTitle" class="col-form-label">Title:</label>
                                <input type="text" class="form-control" id="taskTitle">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="taskStart" class="col-form-label">Start:</label>
                                <input type="text" class="form-control" id="taskStart">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="taskEnd" class="col-form-label">End:</label>
                                <input type="text" class="form-control" id="taskEnd">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="taskTimeStart" class="col-form-label">Start Time:</label>
                                <input type="text" class="form-control" id="taskEnd">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="taskTimeEnd" class="col-form-label">End Time:</label>
                                <input type="text" class="form-control" id="taskEnd">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="prioritySelect" class="col-form-label">Priority:</label>
                                <select class="form-control" id="prioritySelect">
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="repeats" id="repeatsCheck">
                            <label class="form-check-label" for="repeatsCheckTask">
                                Repeats
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-3">
                                <label for="repeatNumberTask" class="col-form-label">Repeats For:</label>
                                <input class="form-control" type="text" id="repeatNumberTask" disabled>
                            </div>
                            <div class="form-group col-3">
                                <label for="intervalSelectTask" class="col-form-label">Time:</label>
                                <select class="form-control" id="intervalSelectTask" disabled>
                                    <option value="d">Day(s)</option>
                                    <option value="w">Week(s)</option>
                                    <option value="m">Month(s)</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="saveTaskBtn" type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="billModal" abindex="-1" role="dialog" aria-labelledby="billLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="billLabel">Bill</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="billPayTo" class="col-form-label">Pay To:</label>
                                <input type="text" class="form-control" id="billPayTo">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="billDue" class="col-form-label">Due Date:</label>
                                <input type="text" class="form-control" id="billDue">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="billAmount" class="col-form-label">Amount:</label>
                                <input type="text" class="form-control" id="billAmount">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label for="billReason" class="col-form-label">Reason:</label>
                                <input type="text" class="form-control" id="billReason">
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="repeats" id="repeatsCheckBill">
                            <label class="form-check-label" for="repeatsCheckBill">
                                Repeats
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-3">
                                <label for="repeatNumberBill" class="col-form-label">Repeats For:</label>
                                <input class="form-control" type="text" id="repeatNumberBill" disabled>
                            </div>
                            <div class="form-group col-3">
                                <label for="intervalSelectBill" class="col-form-label">Time:</label>
                                <select class="form-control" id="intervalSelectBill" disabled>
                                    <option value="d">Day(s)</option>
                                    <option value="w">Week(s)</option>
                                    <option value="m">Month(s)</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="saveBillBtn" type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="eventClickModal" abindex="-1" role="dialog" aria-labelledby="eventLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventLabel">Event</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    You Clicked the <span id="eventIdSpan"></span> Event!
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="startingPatient" value="{{startingPatient}}">